<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Naver Map Test</title>
    <style>
        body { font-family: Arial, Helvetica, sans-serif; margin: 20px; }
        #map { width: 100%; height: 500px; border: 1px solid #ddd; }
    </style>
    <!-- Use current API parameter name (ncpKeyId) and callback per the official tutorial -->
    <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=wohmf5ntoz&callback=init"></script>
</head>
<body>
    <h1>네이버 지도 인증 테스트</h1>
    <p>Client ID: <strong>wohmf5ntoz</strong></p>
    <div id="map">지도 로딩 중...</div>

    <script>
        console.log('test_naver.html 로드');
        function init() {
            console.log('window.naver:', window.naver);
            if (!window.naver || !window.naver.maps) {
                document.getElementById('map').innerText = '네이버 맵 API 로딩 실패 - 콘솔 확인';
                return;
            }
            try {
                var map = new naver.maps.Map('map', {
                    center: new naver.maps.LatLng(37.5665, 126.9780),
                    zoom: 12
                });
                console.log('네이버 맵 생성 성공');
            } catch (e) {
                console.error('맵 생성 에러:', e);
                document.getElementById('map').innerText = '맵 생성 에러: ' + e.message;
            }
        }

        // 기존 폴백: API가 자동으로 callback(init)을 호출하므로 추가 폴링은 안전장치로 유지
        setTimeout(function() {
            if (window.naver && window.naver.maps) {
                init();
            } else {
                console.warn('네이버 API 준비되지 않음, 500ms 후 재시도');
                setTimeout(function() {
                    if (window.naver && window.naver.maps) init();
                    else document.getElementById('map').innerText = '네이버 API가 로드되지 않았습니다 (콘솔 확인)';
                }, 500);
            }
        }, 200);
    </script>

    <!-- 인증 실패(서버 측에서 인증 오류 발생 시 호출되는 전역 훅) -->
    <script>
        window.navermap_authFailure = function() {
            console.error('네이버 맵 인증 실패: window.navermap_authFailure 호출됨');
            const el = document.getElementById('map');
            if (el) {
                el.innerHTML = `\n                    <div style="color: #dc3545; text-align: center; padding: 30px; background: #fff7f7; border: 1px solid #f5c6cb; border-radius: 8px;">\n                        <h3>🛑 네이버 지도 인증 실패</h3>\n                        <p>API 키 또는 허용 출처(Referer)가 올바르지 않습니다.</p>\n                        <p>Client ID: <strong>wohmf5ntoz</strong></p>\n                        <small>브라우저 개발자 도구의 Network 탭에서 maps.js 응답 메시지를 확인한 후, Naver Cloud 콘솔의 허용 출처를 추가하세요.</small>\n                    </div>\n                `;
            }
        };
    </script>

        <!-- 진단용: maps.js 직접 fetch 시도 -> 응답 상태/본문을 콘솔에 출력 (인증 실패 내용을 확인하기 위함) -->
        <script>
            (function diagnosticFetch(){
                // diagnostic: use the same URL format the tutorial recommends
                const url = 'https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=wohmf5ntoz';
                console.log('diagnostic: fetching', url);
                fetch(url, { method: 'GET', mode: 'cors' })
                    .then(async res => {
                        console.log('diagnostic: fetch status', res.status, res.statusText);
                        try {
                            const text = await res.text();
                            console.log('diagnostic: fetch response (first 2000 chars)');
                            console.log(text.substring(0, 2000));
                        } catch (err) {
                            console.error('diagnostic: failed to read response text', err);
                        }
                    })
                    .catch(err => {
                        console.error('diagnostic: fetch error (possible CORS/network)', err);
                    });
            })();
        </script>
</body>
</html>